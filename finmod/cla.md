CLA(critical line a Markowitz)
================

*пример 1*

``` r
library(CLA)
data(muS.sp500)
# fix(muS.sp500)
set.seed(1)
iS <- sample.int(length(muS.sp500$mu), 24)
CLsp.24 <- CLA(muS.sp500$mu[iS], muS.sp500$covar[iS, iS], lB=0, uB=1/10)
CLsp.24 
```

    ## Call: CLA(mu = muS.sp500$mu[iS], covar = muS.sp500$covar[iS, iS], lB = 0, 
    ##     uB = 1/10)
    ## Critical Line Algorithm for n = 24 assets, resulting in  23  turning points
    ## Overview of result parts:
    ## List of 5
    ##  $ weights_set : num [1:24, 1:23] 0 0.1 0 0 0 0 0 0.1 0.1 0 ...
    ##  $ free_indices:List of 23
    ##  $ gammas      : num [1:23] -0.002965 -0.002965 -0.000719 -0.000719 -0.000708 ...
    ##  $ lambdas     : num [1:23] 0.809 0.809 0.308 0.308 0.307 ...
    ##  $ emptyLambdas: list()

``` r
plot(CLsp.24)
```

![](cla_files/figure-gfm/cla-1.png)<!-- -->

``` r
if(require(Matrix)) { ## visualize how weights change "along turning points"
  show(image(Matrix(CLsp.24$weights_set, sparse=TRUE),
             main = "CLA(muS.sp500 <random_sample(size=24)>) $ weights_set",
             xlab = "turning point", ylab = "asset number"))
}
```

    ## Загрузка требуемого пакета: Matrix

![](cla_files/figure-gfm/cla-2.png)<!-- -->

``` r
## A 3x3 example where CLA()'s original version failed and check.f = TRUE' produces a warning :
mc3 <- list(
    mu = c(0.0408, 0.102, -0.023),
    cv = matrix(c(0.00648, 0.00792, 0.00473,
                  0.00792, 0.0334,  0.0121,
                  0.00473, 0.0121, 0.0793), 3, 3,
           dimnames = list(NULL,
                           paste0(c("TLT", "VTI","GLD"), ".Adjusted"))))

rc3 <- with(mc3,  CLA(mu=mu, covar=cv, lB=0, uB=1, trace=TRUE))
```

    ## while(lam = 1 > 0 && |f|=1 <= |mu|=3)
    ## |f| < |mu|: computeLambda() => lam_out[1:2]   --> new k = which.max(lam_out):  1 
    ##   l_{in,out}=(0,0.41634) => new candidate lam=0.41634
    ## while(lam = 0.41634 > 0 && |f|=2 <= |mu|=3)
    ## |f| < |mu|: computeLambda() => lam_out[1:1]   --> new k = which.max(lam_out):  1 
    ##   l_{in,out}=(0.0235294,0.0266832) => new candidate lam=0.0266832
    ## while(lam = 0.0266832 > 0 && |f|=3 <= |mu|=3)
    ##   l_{in,out}=(0.0238216,-Inf) => new candidate lam=0.0238216
    ## while(lam = 0.0238216 > 0 && |f|=2 <= |mu|=3)
    ## |f| < |mu|: computeLambda() => lam_out[1:1]  new 'sml' case: which(sml) =  1 
    ##    --> new k = which.max(lam_out):  1 
    ##   l_{in,out}=(-1.16881,0.0238216) => new candidate lam=0.0238216
    ## while(lam = 0.0238216 > 0 && |f|=3 <= |mu|=3)
    ##   l_{in,out}=(0.0238216,-Inf) => new candidate lam=0.0238216
    ## while(lam = 0.0238216 > 0 && |f|=2 <= |mu|=3)
    ## |f| < |mu|: computeLambda() => lam_out[1:1]  new 'sml' case: which(sml) =  {} (i.e. empty)

    ## Warning in CLA(mu = mu, covar = cv, lB = 0, uB = 1, trace = TRUE): Had free
    ## weights but could not improve solution

    ##   l_{in,out}=(-1.16881,-Inf) => new candidate lam=-1.16881

## data gen( time series correlated variables)

``` r
# Функция для генерации коррелированных временных рядов
generate_correlated_ts <- function(nObs, size0, size1, mu0=0, sigma0=1, sigma1F=0.5, sLength=100) {
# 1) Генерация случайных некоррелированных данных# Каждая строка - это переменная (временной ряд)
  x <- matrix(rnorm(nObs * size0, mean=mu0, sd=sigma0), nrow=nObs, ncol=size0)
  #2) Создание корреляции между переменными
  # Выбираем случайные колонки для создания корреляции
  cols <- sample(1:size0, size1, replace=TRUE)
  # новые коррелированные переменные
  y <- x[, cols] + matrix(rnorm(nObs * size1, mean=0, sd=sigma0*sigma1F), 
                         nrow=nObs, ncol=size1)
  x <- cbind(x, y)
  # общий случайный шок
  point <- sample(sLength:(nObs-1), 2)
  x[point[1], c(cols[1], size0+1)] <- c(-0.5, -0.5)
  x[point[2], c(cols[1], size0+1)] <- c(2, 2)
  # специфический случайный шок
  point <- sample(sLength:(nObs-1), 2)
  x[point[1], cols[length(cols)]] <- -0.5
  x[point[2], cols[length(cols)]] <- 2
# Возвращаем матрицу данных и индексы колонок с корреляцией
  return(list(data=x, cor_cols=cols))
}

nObs <- 500    # Количество наблюдений
size0 <- 5     # Количество исходных переменных
size1 <- 3     # Количество коррелированных переменных для добавления

# Генерация данных
set.seed(123) 
result <- generate_correlated_ts(nObs, size0, size1)
names(result)
```

    ## [1] "data"     "cor_cols"

``` r
x <- result$data
cols <- result$cor_cols
# fix(cols)
```

``` r
# Визуализация нескольких рядов
par(mfrow=c(2, 2))
plot(x[, 1], type="l", main="Исходный ряд 1", ylab="Значение")
plot(x[, size0+1], type="l", main="Коррелированный ряд 1", ylab="Значение")
plot(x[, cols[1]], type="l", main="Ряд с общим шоком", ylab="Значение")
plot(x[, cols[length(cols)]], type="l", main="Ряд со специфическим шоком", ylab="Значение")
```

![](cla_files/figure-gfm/unnamed-chunk-2-1.png)<!-- -->

``` r
# Проверка корреляции
cor.matrix <- cor(x)
print("Корреляционная матрица (первые 10 переменных):")
```

    ## [1] "Корреляционная матрица (первые 10 переменных):"

``` r
print(cor.matrix[1:min(10, ncol(x)), 1:min(10, ncol(x))])
```

    ##             [,1]        [,2]         [,3]        [,4]         [,5]        [,6]
    ## [1,]  1.00000000 -0.05197728  0.059430668 -0.05572723 -0.024300972  0.89896500
    ## [2,] -0.05197728  1.00000000  0.050917968  0.11298743 -0.054602900 -0.01642534
    ## [3,]  0.05943067  0.05091797  1.000000000 -0.15796588  0.005259548  0.05357068
    ## [4,] -0.05572723  0.11298743 -0.157965878  1.00000000 -0.010030857 -0.05433165
    ## [5,] -0.02430097 -0.05460290  0.005259548 -0.01003086  1.000000000 -0.03098165
    ## [6,]  0.89896500 -0.01642534  0.053570684 -0.05433165 -0.030981653  1.00000000
    ## [7,]  0.04379449  0.03781995  0.890840123 -0.16307646 -0.022141267  0.05469261
    ## [8,]  0.89641291 -0.03790481  0.049387207 -0.03364653 -0.001341973  0.82316566
    ##             [,7]         [,8]
    ## [1,]  0.04379449  0.896412912
    ## [2,]  0.03781995 -0.037904806
    ## [3,]  0.89084012  0.049387207
    ## [4,] -0.16307646 -0.033646527
    ## [5,] -0.02214127 -0.001341973
    ## [6,]  0.05469261  0.823165662
    ## [7,]  1.00000000  0.050325852
    ## [8,]  0.05032585  1.000000000

*1* CLA(markowitz)

``` r
library(CLA)
# mu=c(0.02,-0.03,0.04, 0.01, -0.01, 0.03, 0.055, 0.003)
# CLA::CLA(mu=mu,covar=cor.matrix, lB=0, uB=1)
# CLA::CLA(mu=mu,covar=cor.matrix, lB=0, uB=1)$weights
# CLA::muSigmaGarch()

cla1 <- CLA(muS.sp500$mu[iS], muS.sp500$covar[iS, iS], lB=0, uB=1/10)
cla1 
```

    ## Call: CLA(mu = muS.sp500$mu[iS], covar = muS.sp500$covar[iS, iS], lB = 0, 
    ##     uB = 1/10)
    ## Critical Line Algorithm for n = 24 assets, resulting in  23  turning points
    ## Overview of result parts:
    ## List of 5
    ##  $ weights_set : num [1:24, 1:23] 0 0.1 0 0 0 0 0 0.1 0.1 0 ...
    ##  $ free_indices:List of 23
    ##  $ gammas      : num [1:23] -0.002965 -0.002965 -0.000719 -0.000719 -0.000708 ...
    ##  $ lambdas     : num [1:23] 0.809 0.809 0.308 0.308 0.307 ...
    ##  $ emptyLambdas: list()

``` r
names(cla1)
```

    ## [1] "weights_set"  "free_indices" "gammas"       "lambdas"      "emptyLambdas"
    ## [6] "MS_weights"   "call"

``` r
cla1$weights_set
```

    ##      [,1] [,2] [,3] [,4]         [,5]        [,6]          [,7]       [,8]
    ## NYT   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## FCX   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## DDS   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## TJX   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## XRX   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## MTG   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## M     0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## X     0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## GGP   0.1  0.1  0.1  0.1 1.000000e-01 0.094957978  5.446692e-02 0.01081958
    ## NCC   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## CCE   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000 -5.551115e-17 0.10000000
    ## MCK   0.0  0.0  0.0  0.0 1.110223e-16 0.005042022  5.529550e-02 0.03826199
    ## R     0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## UST   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## PAYX  0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## LOW   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## OXY   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## CAG   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## HPQ   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## APD   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## CNX   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## HUM   0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  1.000000e-01 0.10000000
    ## RHI   0.0  0.0  0.0  0.0 0.000000e+00 0.000000000  0.000000e+00 0.00000000
    ## EXPD  0.1  0.1  0.1  0.1 1.000000e-01 0.100000000  9.023758e-02 0.05091844
    ##             [,9]       [,10]        [,11]      [,12]      [,13]         [,14]
    ## NYT  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## FCX  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  9.483802e-02
    ## DDS  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## TJX  0.000000000 0.000000000 1.040834e-17 0.01322003 0.03024151  3.752093e-02
    ## XRX  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## MTG  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## M    0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## X    0.100000000 0.100000000 8.485748e-02 0.07230692 0.05504296  5.035789e-02
    ## GGP  0.004366139 0.001963002 1.570644e-03 0.00000000 0.00000000  0.000000e+00
    ## NCC  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## CCE  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  1.000000e-01
    ## MCK  0.046271354 0.058127765 7.192425e-02 0.07629500 0.08184088  8.397577e-02
    ## R    0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000 -6.938894e-18
    ## UST  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  1.000000e-01
    ## PAYX 0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## LOW  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## OXY  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  1.000000e-01
    ## CAG  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## HPQ  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  1.000000e-01
    ## APD  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  1.000000e-01
    ## CNX  0.100000000 0.085266337 7.872461e-02 0.07264433 0.06428350  6.321212e-02
    ## HUM  0.100000000 0.100000000 1.000000e-01 0.10000000 0.10000000  1.000000e-01
    ## RHI  0.000000000 0.000000000 0.000000e+00 0.00000000 0.00000000  0.000000e+00
    ## EXPD 0.049362506 0.054642896 6.292302e-02 0.06553372 0.06859115  7.009528e-02
    ##            [,15]       [,16]      [,17]       [,18]      [,19]      [,20]
    ## NYT  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## FCX  0.055635771 0.053500949 0.01084028 0.004212563 0.00000000 0.00000000
    ## DDS  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## TJX  0.066167143 0.066282741 0.06786842 0.068207442 0.07048586 0.07058891
    ## XRX  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## MTG  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## M    0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## X    0.002209923 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## GGP  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## NCC  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## CCE  0.100000000 0.100000000 0.10000000 0.100000000 0.10000000 0.10000000
    ## MCK  0.087992249 0.087035528 0.07182725 0.069495862 0.06978055 0.06981036
    ## R    0.075157085 0.076961350 0.09254574 0.095120130 0.09975573 0.10000000
    ## UST  0.100000000 0.100000000 0.10000000 0.100000000 0.10000000 0.10000000
    ## PAYX 0.000000000 0.005258574 0.08662577 0.100000000 0.10000000 0.10000000
    ## LOW  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## OXY  0.100000000 0.100000000 0.10000000 0.098885430 0.09883079 0.09872437
    ## CAG  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## HPQ  0.100000000 0.100000000 0.10000000 0.100000000 0.10000000 0.10000000
    ## APD  0.100000000 0.100000000 0.10000000 0.100000000 0.10000000 0.10000000
    ## CNX  0.050982857 0.050488766 0.03262780 0.030106338 0.02799217 0.02778394
    ## HUM  0.100000000 0.100000000 0.10000000 0.100000000 0.10000000 0.10000000
    ## RHI  0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000
    ## EXPD 0.061854971 0.060472092 0.03766474 0.033972234 0.03315490 0.03309242
    ##              [,21]         [,22]       [,23]
    ## NYT   0.000000e+00  0.000000e+00 0.000000000
    ## FCX   0.000000e+00  0.000000e+00 0.000000000
    ## DDS   0.000000e+00  0.000000e+00 0.000000000
    ## TJX   7.424336e-02  7.669971e-02 0.083453378
    ## XRX  -9.540979e-18  3.407930e-03 0.015690170
    ## MTG   0.000000e+00  0.000000e+00 0.000000000
    ## M     0.000000e+00  0.000000e+00 0.000000000
    ## X     0.000000e+00  0.000000e+00 0.000000000
    ## GGP   0.000000e+00  0.000000e+00 0.000000000
    ## NCC   0.000000e+00  0.000000e+00 0.000000000
    ## CCE   1.000000e-01  1.000000e-01 0.100000000
    ## MCK   7.111805e-02  7.186297e-02 0.070676938
    ## R     1.000000e-01  1.000000e-01 0.100000000
    ## UST   1.000000e-01  1.000000e-01 0.100000000
    ## PAYX  1.000000e-01  1.000000e-01 0.100000000
    ## LOW   0.000000e+00  0.000000e+00 0.000000000
    ## OXY   9.707407e-02  9.486818e-02 0.082817283
    ## CAG   0.000000e+00 -1.214306e-17 0.015663293
    ## HPQ   1.000000e-01  1.000000e-01 0.100000000
    ## APD   1.000000e-01  1.000000e-01 0.100000000
    ## CNX   2.433863e-02  2.039138e-02 0.002976094
    ## HUM   1.000000e-01  1.000000e-01 0.100000000
    ## RHI   0.000000e+00  0.000000e+00 0.000000000
    ## EXPD  3.322590e-02  3.276983e-02 0.028722844

``` r
plot(cla1)
```

![](cla_files/figure-gfm/unnamed-chunk-4-1.png)<!-- -->
